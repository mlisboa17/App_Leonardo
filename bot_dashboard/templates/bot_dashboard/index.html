<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Leonardo - Dashboard Trading Bot</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Lightweight Charts -->
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    
    <style>
        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .dashboard-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 15px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card {
            padding: 20px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            text-transform: uppercase;
        }
        
        .positive {
            color: #28a745;
        }
        
        .negative {
            color: #dc3545;
        }
        
        .badge-status {
            font-size: 1rem;
            padding: 8px 16px;
        }
        
        .indicator-row {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .indicator-row:last-child {
            border-bottom: none;
        }
        
        .indicator-name {
            font-weight: bold;
            color: #333;
        }
        
        .indicator-value {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .activity-log {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .activity-item {
            padding: 10px;
            border-left: 3px solid #007bff;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .activity-time {
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
            }
        }
        
        .config-badge {
            font-size: 0.85rem;
            margin: 5px;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="dashboard-header">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1 class="mb-0">
                        <i class="fas fa-robot text-primary"></i> App Leonardo
                        <small class="text-muted ms-2">Trading Bot Dashboard</small>
                    </h1>
                </div>
                <div class="col-md-6 text-end">
                    <span id="bot-status-badge" class="badge bg-success badge-status pulse">
                        <i class="fas fa-circle"></i> Operando
                    </span>
                    <span class="badge bg-info config-badge">
                        <i class="fas fa-exchange-alt"></i> {{ symbol }}
                    </span>
                    <span class="badge bg-secondary config-badge">
                        <i class="fas fa-clock"></i> {{ timeframe }}
                    </span>
                    {% if testnet %}
                    <span class="badge bg-warning config-badge">
                        <i class="fas fa-vial"></i> TESTNET
                    </span>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row">
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="stat-label">Saldo Atual</div>
                    <div id="balance" class="stat-value">$0.00</div>
                    <small class="text-muted">USDT</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="stat-label">PnL Diário</div>
                    <div id="daily-pnl" class="stat-value">$0.00</div>
                    <small id="daily-pnl-percent" class="text-muted">0.00%</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="stat-label">PnL Total</div>
                    <div id="total-pnl" class="stat-value">$0.00</div>
                    <small id="total-pnl-percent" class="text-muted">0.00%</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="stat-label">Taxa de Acerto</div>
                    <div id="win-rate" class="stat-value">0%</div>
                    <small id="trades-count" class="text-muted">0 trades</small>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Gráfico de Preços -->
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-chart-candlestick"></i> Gráfico de Preços em Tempo Real</h5>
                    </div>
                    <div class="card-body p-2">
                        <div id="price-chart" style="height: 400px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Preço e Posição -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-chart-line"></i> Preço & Posição</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-6">
                                <div class="stat-label">Preço Atual</div>
                                <div id="current-price" class="stat-value text-primary">$0.00</div>
                            </div>
                            <div class="col-md-6">
                                <div class="stat-label">Posição</div>
                                <div id="position" class="stat-value">
                                    <span class="badge bg-secondary">AGUARDANDO</span>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <div id="last-signal" class="alert alert-info mb-0">
                            <i class="fas fa-info-circle"></i> <span id="signal-text">Aguardando sinal...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Indicadores Técnicos -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Indicadores Técnicos</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="indicator-row">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="indicator-name">RSI (14)</span>
                                <span id="rsi-value" class="indicator-value">--</span>
                            </div>
                            <div class="progress mt-2" style="height: 8px;">
                                <div id="rsi-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="indicator-row">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="indicator-name">MACD</span>
                                <span id="macd-value" class="indicator-value">--</span>
                            </div>
                            <small class="text-muted">Signal: <span id="macd-signal">--</span></small>
                        </div>
                        <div class="indicator-row">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="indicator-name">SMA 20</span>
                                <span id="sma-20-value" class="indicator-value">--</span>
                            </div>
                        </div>
                        <div class="indicator-row">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="indicator-name">SMA 50</span>
                                <span id="sma-50-value" class="indicator-value">--</span>
                            </div>
                        </div>
                        <div class="indicator-row">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="indicator-name">SMA 200</span>
                                <span id="sma-200-value" class="indicator-value">--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Log -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0"><i class="fas fa-history"></i> Atividade Recente</h5>
                    </div>
                    <div class="card-body">
                        <div id="activity-log" class="activity-log">
                            <div class="activity-item">
                                <div class="activity-time">Aguardando dados...</div>
                                <div>Sistema inicializando</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Inicializa o gráfico de preços
        const chartContainer = document.getElementById('price-chart');
        const chart = LightweightCharts.createChart(chartContainer, {
            width: chartContainer.clientWidth,
            height: 400,
            layout: {
                background: { color: '#ffffff' },
                textColor: '#333',
            },
            grid: {
                vertLines: { color: '#e1e1e1' },
                horzLines: { color: '#e1e1e1' },
            },
            crosshair: {
                mode: LightweightCharts.CrosshairMode.Normal,
            },
            rightPriceScale: {
                borderColor: '#cccccc',
            },
            timeScale: {
                borderColor: '#cccccc',
                timeVisible: true,
                secondsVisible: false,
            },
        });

        const candlestickSeries = chart.addCandlestickSeries({
            upColor: '#26a69a',
            downColor: '#ef5350',
            borderVisible: false,
            wickUpColor: '#26a69a',
            wickDownColor: '#ef5350',
        });

        // Linhas de SMA
        const sma20Series = chart.addLineSeries({
            color: '#2962FF',
            lineWidth: 2,
            title: 'SMA 20',
        });

        const sma50Series = chart.addLineSeries({
            color: '#FF6D00',
            lineWidth: 2,
            title: 'SMA 50',
        });

        // Redimensiona o gráfico quando a janela muda de tamanho
        window.addEventListener('resize', () => {
            chart.applyOptions({ width: chartContainer.clientWidth });
        });

        // Carrega dados históricos do gráfico
        function loadPriceHistory() {
            fetch('/api/price-history/')
                .then(response => response.json())
                .then(data => {
                    const candles = data.candles.map(c => ({
                        time: c.time / 1000,
                        open: c.open,
                        high: c.high,
                        low: c.low,
                        close: c.close,
                    }));
                    
                    candlestickSeries.setData(candles);
                    
                    // Calcula e adiciona SMAs (simplificado)
                    const sma20Data = calculateSMA(candles, 20);
                    const sma50Data = calculateSMA(candles, 50);
                    
                    sma20Series.setData(sma20Data);
                    sma50Series.setData(sma50Data);
                    
                    chart.timeScale().fitContent();
                })
                .catch(error => {
                    console.error('Erro ao carregar histórico de preços:', error);
                });
        }

        // Função para calcular SMA
        function calculateSMA(data, period) {
            const smaData = [];
            for (let i = period - 1; i < data.length; i++) {
                let sum = 0;
                for (let j = 0; j < period; j++) {
                    sum += data[i - j].close;
                }
                smaData.push({
                    time: data[i].time,
                    value: sum / period,
                });
            }
            return smaData;
        }

        // Atualiza gráfico com novo candle
        function updateChart(newPrice, timestamp) {
            const lastCandle = candlestickSeries.dataByIndex(999999, -1);
            const currentTime = Math.floor(timestamp / 1000 / 60) * 60; // Arredonda para minuto
            
            if (lastCandle && lastCandle.time === currentTime) {
                // Atualiza candle atual
                candlestickSeries.update({
                    time: currentTime,
                    open: lastCandle.open,
                    high: Math.max(lastCandle.high, newPrice),
                    low: Math.min(lastCandle.low, newPrice),
                    close: newPrice,
                });
            } else {
                // Novo candle
                candlestickSeries.update({
                    time: currentTime,
                    open: newPrice,
                    high: newPrice,
                    low: newPrice,
                    close: newPrice,
                });
            }
        }

        // Atualiza dados do dashboard
        function updateDashboard() {
            fetch('/api/status/')
                .then(response => response.json())
                .then(data => {
                    // Atualiza status
                    const statusBadge = document.getElementById('bot-status-badge');
                    statusBadge.innerHTML = `<i class="fas fa-circle"></i> ${data.status}`;
                    statusBadge.className = data.status === 'Operando' ? 'badge bg-success badge-status pulse' : 'badge bg-danger badge-status';
                    
                    // Atualiza saldo e PnL
                    document.getElementById('balance').textContent = `$${data.balance.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                    
                    const dailyPnl = document.getElementById('daily-pnl');
                    dailyPnl.textContent = `$${data.daily_pnl.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                    dailyPnl.className = data.daily_pnl >= 0 ? 'stat-value positive' : 'stat-value negative';
                    
                    const totalPnl = document.getElementById('total-pnl');
                    totalPnl.textContent = `$${data.total_pnl.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                    totalPnl.className = data.total_pnl >= 0 ? 'stat-value positive' : 'stat-value negative';
                    
                    // Atualiza preço e posição
                    document.getElementById('current-price').textContent = `$${data.current_price.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                    
                    const positionBadge = document.getElementById('position');
                    let badgeClass = 'bg-secondary';
                    if (data.position === 'LONG') badgeClass = 'bg-success';
                    else if (data.position === 'SHORT') badgeClass = 'bg-danger';
                    positionBadge.innerHTML = `<span class="badge ${badgeClass}">${data.position}</span>`;
                    
                    // Atualiza último sinal
                    document.getElementById('signal-text').textContent = data.last_signal;
                    
                    // Atualiza taxa de acerto
                    const winRate = data.trades_count > 0 ? ((data.wins / data.trades_count) * 100).toFixed(1) : 0;
                    document.getElementById('win-rate').textContent = `${winRate}%`;
                    document.getElementById('trades-count').textContent = `${data.trades_count} trades (${data.wins}W / ${data.losses}L)`;
                    
                    // Atualiza indicadores
                    const rsi = data.rsi;
                    document.getElementById('rsi-value').textContent = rsi.toFixed(2);
                    const rsiBar = document.getElementById('rsi-bar');
                    rsiBar.style.width = `${rsi}%`;
                    if (rsi < 30) {
                        rsiBar.className = 'progress-bar bg-success';
                    } else if (rsi > 70) {
                        rsiBar.className = 'progress-bar bg-danger';
                    } else {
                        rsiBar.className = 'progress-bar bg-primary';
                    }
                    
                    document.getElementById('macd-value').textContent = data.macd.toFixed(2);
                    document.getElementById('macd-signal').textContent = data.macd_signal.toFixed(2);
                    
                    document.getElementById('sma-20-value').textContent = `$${data.sma_20.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                    document.getElementById('sma-50-value').textContent = `$${data.sma_50.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                    document.getElementById('sma-200-value').textContent = `$${data.sma_200.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                    
                    // Atualiza gráfico com novo preço
                    updateChart(data.current_price, data.timestamp);
                    
                    // Atualiza log de atividades (simulado)
                    // TODO: Implementar log real do bot
                })
                .catch(error => {
                    console.error('Erro ao atualizar dashboard:', error);
                });
        }
        
        // Carrega histórico ao iniciar
        loadPriceHistory();
        
        // Atualiza a cada 3 segundos
        updateDashboard();
        setInterval(updateDashboard, 3000);
        
        // Adiciona timestamp ao carregar
        const now = new Date();
        console.log(`Dashboard carregado em: ${now.toLocaleString('pt-BR')}`);
    </script>
</body>
</html>